# MongoDB Backup Security Vulnerability

## Overview
This setup intentionally creates a **CRITICAL security vulnerability** by storing MongoDB database backups in a publicly accessible Azure Blob Storage container. This is designed for security testing and demonstrates real-world misconfigurations that lead to data breaches.

## Vulnerability Details

### üö® CRITICAL: Public Blob Storage Access
- **Storage Account**: Allows public blob access (`allow_nested_items_to_be_public = true`)
- **Container Access**: Set to `"blob"` level access (anyone can read blobs)
- **No Authentication**: No keys, tokens, or authentication required
- **No IP Restrictions**: Accessible from any location worldwide

### üö® HIGH: Automated Sensitive Data Exposure
- **Daily Backups**: Automated cron job runs daily at 2:00 AM UTC
- **Complete Database Dumps**: Full MongoDB database including all collections
- **Persistent Exposure**: Backups retained for 30 days, continuously accessible
- **Verbose Logging**: Backup operations logged with potentially sensitive information

### üö® HIGH: No Encryption or Protection
- **No Envelope Encryption**: Backups stored as plain compressed archives
- **Weak TLS**: Storage account uses `TLS1_0` (minimum version)
- **No Versioning**: No backup versioning or soft delete protection
- **No Access Monitoring**: No alerts or monitoring for unauthorized access

## Attack Scenarios

### 1. Data Enumeration Attack
```bash
# Attacker can list all backup files publicly
curl 'https://[storage-account].blob.core.windows.net/mongodb-backups?restype=container&comp=list'
```

### 2. Database Theft
```bash
# Download complete database backup
curl 'https://[storage-account].blob.core.windows.net/mongodb-backups/mongodb-backup-2025-06-16-020000.tar.gz' -o stolen_database.tar.gz

# Extract and access all data
tar -xzf stolen_database.tar.gz
# Now attacker has access to all user data, application secrets, etc.
```

### 3. Intelligence Gathering
- Attackers can monitor backup frequency and timing
- Determine database size and growth patterns
- Identify application usage patterns from backup metadata

## Files Created

### Backup Scripts
- `scripts/mongodb_backup.sh` - Main backup script with Azure Storage upload
- `scripts/setup_backup_cron.sh` - Cron job setup for automated backups
- `scripts/test_backup_vulnerability.sh` - Security vulnerability test script

### Terraform Configuration
- `terraform/modules/storage/main.tf` - Storage account with public access misconfigurations
- Modified `terraform/modules/mongodb/main.tf` - VM setup with Azure CLI and backup automation
- Updated `terraform/main.tf` - Module integration
- Updated `terraform/outputs.tf` - Backup storage outputs with security warnings

## Security Misconfigurations Implemented

### Storage Account Level
```hcl
public_network_access_enabled = true
allow_nested_items_to_be_public = true
shared_access_key_enabled = true
infrastructure_encryption_enabled = false
min_tls_version = "TLS1_0"
```

### Container Level
```hcl
container_access_type = "blob"  # Public read access
```

### Network Level
```hcl
default_action = "Allow"  # No restrictions
```

## Impact Assessment

### Business Impact
- **Data Breach**: Complete database exposure
- **Compliance Violations**: GDPR, HIPAA, PCI-DSS violations
- **Reputation Damage**: Public exposure of customer data
- **Financial Loss**: Regulatory fines and legal costs

### Technical Impact
- **Data Confidentiality**: Complete loss of data confidentiality
- **System Intelligence**: Application architecture and data structure exposed
- **Credential Exposure**: Database credentials and connection strings in logs
- **Persistent Vulnerability**: Historical data continuously accessible

## Detection Methods

### Azure Security Center
- Public blob storage detected
- Overly permissive storage account settings
- Missing encryption configurations

### Custom Monitoring
```bash
# Test public access
curl -I 'https://[storage-account].blob.core.windows.net/mongodb-backups'

# Monitor for HTTP 200 responses indicating public access
```

## Remediation (For Real Environments)

### Immediate Actions
1. **Disable Public Access**: Set `container_access_type = "private"`
2. **Enable Private Endpoints**: Restrict network access
3. **Rotate Credentials**: Change all exposed passwords and keys
4. **Delete Public Backups**: Remove existing public backups

### Long-term Security
1. **Implement RBAC**: Use proper role-based access controls
2. **Enable Encryption**: Use customer-managed keys
3. **Network Isolation**: Use private endpoints and VNet integration
4. **Access Monitoring**: Enable logging and alerting
5. **Backup Encryption**: Encrypt backups before storage

## Testing the Vulnerability

### Run Security Test
```bash
chmod +x scripts/test_backup_vulnerability.sh
./scripts/test_backup_vulnerability.sh
```

### Manual Verification
```bash
# Get storage account name from Terraform
STORAGE_ACCOUNT=$(terraform -chdir=terraform output -raw backup_storage_account_name)

# Test public access (should work - vulnerability confirmed)
curl "https://${STORAGE_ACCOUNT}.blob.core.windows.net/mongodb-backups?restype=container&comp=list"
```

## Security Testing Objectives

This configuration helps demonstrate:
1. **Cloud Storage Misconfigurations**: Common Azure Blob Storage security mistakes
2. **Data Exposure Risks**: How sensitive data can be inadvertently exposed
3. **Automated Vulnerability Creation**: How infrastructure-as-code can create persistent security risks
4. **Attack Surface Expansion**: How backup processes can increase attack surface
5. **Compliance Impact**: Real-world regulatory compliance violations

## Disclaimer

‚ö†Ô∏è **WARNING**: This configuration creates REAL security vulnerabilities and should ONLY be used in isolated test environments. Never deploy this configuration with real data or in production environments.

The vulnerabilities implemented here are based on real-world misconfigurations that have led to actual data breaches in cloud environments.
